# WSI Pyramid Downsampling Configuration

## Purpose

This document describes the Digital Pathology Transformation Pipeline whole
slide imaging layer generation downsampling configuration.

## Background

The Digital Pathology Transformation Pipeline transforms whole slide imaging
into DICOM formatted image pyramids. Each layer of the pyramid represents the
image at specific
[pixel spacing](https://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_10.7.html#sect_10.7.1.3)
(mm/pixel) and is represented by one or more DICOM instances. For the purposes
of this document pixel spacing can be thought of as image magnification; pixel
spacing decreases as magnification increases. However, the
[actual image magnification](https://www.sciencedirect.com/science/article/pii/S2153353922006423)
of the image as seen on a monitor is the product of multiple factors, e.g.,
image pixel spacing, monitor DPI, viewer distance, etc. The image pyramid
representation enables DICOM images to be efficiently visualized at multiple
magnifications, e.g., thumbnail sized image-to-gigi-pixel. However, this comes
at the expense of a modest increase in the image storage.

![alt text](https://dicom.nema.org/dicom/dicomwsi/sup145_fromword_files/image010.gif)

The Digital Pathology Transformation pipeline enables customers to define the
levels of the pyramid that will be generated and stored as DICOM. Omitting the
first downsampled layer, e.g., a 20x image from the image pyramid captured at
40x, will result in ~20% reduction in the total cost of storage for the image
pyramid. Representations of the DICOM not stored can then be created, if needed,
at a later time from higher magnification imaging.

## Configuring the Generation of Downsampled Levels

The levels generated by the Digital Pathology Transformation Pipeline are
configured through a configuration file. The path to configuration is defined by
the environmental variable `INGESTION_PYRAMID_LAYER_GENERATION_CONFIG_PATH`.
The environmental variable is initialized by the IAC to point to a default
pyramid configuration. If the environmental variable is not defined, then a
"Full Pyramid" will be generated.

### Custom Pyramid Configuration (Default Behavior)

The Transformation Pipeline IAC configures the
`INGESTION_PYRAMID_LAYER_GENERATION_CONFIG_PATH` to read a default configuration
mounted within the container at:  `/default_config.yaml`.  An alternative
configuration can be mounted into pre-built containers using
[kubernetes config maps](https://kubernetes.io/docs/concepts/configuration/configmap/).
The transformation pipeline supports reading either JSON or YAML formatted
configurations.

#### Configuration overview:

Regardless of the custom pyramid configuration the DICOM Transformation pipeline
will always implicitly generate and ingest two representations of the WSI image
into the DICOM store.

1. The highest  magnification image (1x downsample).
2. A thumbnail representation of the WSI image downsampled sufficiently to
    fit entirely within a single DICOM pyramid frame.

All additional downsampling configurations must be defined within the
downsampling configuration file. Implicitly generated downsampled magnifications
can be explicitly represented within the configuration. The configuration file
defines a dictionary mapping between a pixel spacing (mm/px) and a list of
downsampling factors. To determine the downsample layers to generate for a WSI
image the transformation pipeline:

1. Determines the pixel spacing of the highest magnification imaging in the
    WSI input.
2. The transformation pipeline then selects the downsampling configuration
    that is mapped by the largest pixel spacing value that is less than or
    equal to the input WSI image's pixel spacing.
3. If the pixel spacing of the input WSI is smaller than all configuration
    pixel spacings then the downsampling configuration with the smallest pixel
    spacing is used.

##### Single Downsampling Configuration

<table>
  <thead>
    <tr>
      <th>Default JSON Config</th>
      <th>Default YAML Config</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><p><pre>
{
</pre></p>

<p><pre>
  "0.0001": [1, 4, 16, 64]
</pre></p>

<p><pre>
}
</pre></p></td>
      <td><p><pre>
0.0001: [1, 4, 16, 64]
</pre></p></td>
    </tr>
  </tbody>
</table>

A downsampling configuration file is required to define at least one
downsampling mapping between a pixel spacing and list of downsampling scaling
factors. The default configuration defines a single pixel space mapping as shown
above in both JSON and YAML syntax. When a single downsampling configuration is
defined the downsample configuration is used for all image inputs regardless of
their pixelspacing, i.e. the pixel spacing key is meaningless.

##### Multiple Downsampling Configuration

<table>
  <thead>
    <tr>
      <th>JSON Config</th>
      <th>YAML Config</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><p><pre>
{
</pre></p>

<p><pre>
  "0.0001": [1, 4, 16, 64]
</pre></p>

<p><pre>
  "0.0010": [1, 4, 16]
</pre></p>

<p><pre>
}
</pre></p></td>
      <td><p><pre>
0.0001: [1, 4, 16, 64]
</pre></p>

<p><pre>
0.0010: [1, 4, 16]
</pre></p></td>
    </tr>
  </tbody>
</table>

The configurations above describe configurations which define two pixel spacing
mapping.  One for images with pixel spacing >= 0.0010 mm/px that maps to `1x,
4x, and 16x `downsamples and one for everything else that defines `1x, 4x, 16x,
and 64x `downsamples.  The examples below illustrate how the pixel spacing
configuration would be used on input WSI images with different pixel spacing.

<table>
  <thead>
    <tr>
      <th>Smallest Pixel Spacing in input WSI Imaging</th>
      <th>Downsampling Configuration Used</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0.09 mm/px</td>
      <td><p><pre>
[1x, 4x, 16x]
</pre></p></td>
    </tr>
    <tr>
      <td>0.009 mm/px</td>
      <td><p><pre>
[1x, 4x, 16x, 64x]
</pre></p></td>
    </tr>
    <tr>
      <td>0.0009 mm/px</td>
      <td><p><pre>
[1x, 4x, 16x, 64x]
</pre></p></td>
    </tr>
  </tbody>
</table>

### Generating "Full Pyramids"

Not defining the `INGESTION_PYRAMID_LAYER_GENERATION_CONFIG_PATH `environmental
variable will result in the Transformation Pipeline generating a "Full Pyramid"
for all input WSI imaging. Specifically, the pipeline will repeatedly generate
2X downsamples until imaging entirely fits within a single DICOM frame. The
dimensions of a DICOM frame are defined in the Transformation Pipleine's
configuration or within the input imaging.

As an conceptual example, if an image was acquired at ~40x at and the resulting
highest magnification image was 25,000px x 15,000px and the image was tiled
using 256 px x 256 px frames then the following image pyramid would be
generated:

<table>
  <thead>
    <tr>
      <th><strong>Pyramid Level</strong></th>
      <th><strong>Magnification</strong></th>
      <th><strong>Rows (px)</strong></th>
      <th><strong>Columns (px)</strong></th>
      <th><strong>Frames (#)</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>40x</td>
      <td>25000</td>
      <td>15000</td>
      <td>5782</td>
    </tr>
    <tr>
      <td>2</td>
      <td>20x</td>
      <td>12500</td>
      <td>7500</td>
      <td>1470</td>
    </tr>
    <tr>
      <td>3</td>
      <td>10x</td>
      <td>6250</td>
      <td>3750</td>
      <td>375</td>
    </tr>
    <tr>
      <td>4</td>
      <td>5x</td>
      <td>3125</td>
      <td>1875</td>
      <td>104</td>
    </tr>
    <tr>
      <td>5</td>
      <td>2.5x</td>
      <td>1562</td>
      <td>937</td>
      <td>28</td>
    </tr>
    <tr>
      <td>6</td>
      <td>1.25x</td>
      <td>781</td>
      <td>468</td>
      <td>8</td>
    </tr>
    <tr>
      <td>7</td>
      <td>0.625x</td>
      <td>390</td>
      <td>234</td>
      <td>2</td>
    </tr>
    <tr>
      <td>8</td>
      <td>0.313x</td>
      <td>195</td>
      <td>117</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
